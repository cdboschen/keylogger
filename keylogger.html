<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Catalog your keys and use AI to identify them from photos">
  <meta name="theme-color" content="#667eea">
  <title>Key Catalog</title>

  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIktleSBDYXRhbG9nIiwKICAic2hvcnRfbmFtZSI6ICJLZXlzIiwKICAiZGVzY3JpcHRpb24iOiAiQ2F0YWxvZyB5b3VyIGtleXMgYW5kIHVzZSBBSSB0byBpZGVudGlmeSB0aGVtIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjVmNWY1IiwKICAidGhlbWVfY29sb3IiOiAiIzY2N2VlYSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQTFNVElnTlRFeUlqNDhjbVZqZENCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUlnWm1sc2JEMGlJell4TnpobFlTSXZQangwWlhoMElIZzlJakkxTmlJZ2VUMGlNamt3SWlCbWIyNTBMWE5wZW1VOUlqSXdNQ0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJZ1pHOXRhVzVoYm5RdFltRnpaV3hwYm1VOUltMXBaR1JzWlNJZ1ptbHNiRDBpSXpCbVptWm1aaUkrOEorVWtUd3ZkR1Y0ZEQ0OEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">

  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzY2N2VlYSIvPjx0ZXh0IHg9IjI1NiIgeT0iMjkwIiBmb250LXNpemU9IjIwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0iI2ZmZiI+8J+UkTwvdGV4dD48L3N2Zz4=">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      border-radius: 16px;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-danger {
      background: #fee2e2;
      color: #dc2626;
      padding: 8px 12px;
      font-size: 14px;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .key-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .key-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .key-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .key-card-content {
      padding: 16px;
    }

    .key-card h3 {
      margin-bottom: 8px;
      font-size: 18px;
    }

    .key-card .description {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .key-card .date {
      color: #999;
      font-size: 12px;
      margin-bottom: 12px;
    }

    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .result-box {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .result-success {
      background: #d1fae5;
    }

    .result-error {
      background: #fee2e2;
    }

    .hidden {
      display: none;
    }

    .loading {
      text-align: center;
      color: #667eea;
      font-size: 18px;
      padding: 40px;
    }

    .empty-state {
      text-align: center;
      color: #666;
      padding: 40px;
    }

    .image-preview {
      margin-top: 12px;
      max-width: 200px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    input[type="file"] {
      display: none;
    }

    .file-btn {
      background: #f3f4f6;
      border: 1px solid #ddd;
      color: #333;
      padding: 10px 16px;
      font-size: 14px;
    }
  </style>

</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîë Key Catalog</h1>
      <p>Catalog your keys and use AI to identify them from photos</p>
    </div>

```
<div id="loading" class="card loading hidden">
  Loading your key catalog...
</div>

<div id="app" class="hidden">
  <div class="button-group">
    <button class="btn-primary" onclick="toggleAddForm()">
      ‚ûï Add New Key
    </button>
    <button class="btn-success" id="identifyBtn" onclick="document.getElementById('recognizeInput').click()">
      üîç Identify a Key
    </button>
    <input type="file" id="recognizeInput" accept="image/*" onchange="recognizeKey(event)">
  </div>

  <div id="addForm" class="card hidden">
    <h2>Add New Key</h2>
    <div class="form-group">
      <label>Key Name *</label>
      <input type="text" id="keyName" placeholder="e.g., Front Door, Car Key, Office">
    </div>
    <div class="form-group">
      <label>Description (optional)</label>
      <input type="text" id="keyDescription" placeholder="e.g., Silver key with blue head">
    </div>
    <div class="form-group">
      <label>Photo *</label>
      <button class="file-btn" onclick="document.getElementById('keyImage').click()">
        üì§ Choose Image
      </button>
      <input type="file" id="keyImage" accept="image/*" onchange="previewImage(event)">
      <img id="imagePreview" class="image-preview hidden">
    </div>
    <button class="btn-primary" onclick="addKey()">Add to Catalog</button>
  </div>

  <div id="recognizing" class="card hidden">
    <div class="loading">üîç Analyzing key...</div>
  </div>

  <div id="recognitionResult" class="card hidden">
    <h2>Recognition Result</h2>
    <div id="resultImages" class="result-grid"></div>
    <div id="resultInfo" class="result-box"></div>
    <button class="btn-primary" onclick="clearResult()">Clear Result</button>
  </div>

  <div>
    <h2 id="catalogTitle">Your Keys (0)</h2>
    <div id="emptyState" class="card empty-state">
      <div style="font-size: 48px; opacity: 0.5; margin-bottom: 16px;">üì∑</div>
      <p>No keys in your catalog yet. Add your first key to get started!</p>
    </div>
    <div id="keyGrid" class="key-grid hidden"></div>
  </div>
</div>
```

  </div>

  <script>
    let keys = [];
    let currentImageData = null;

    // Initialize app
    window.addEventListener('DOMContentLoaded', () => {
      console.log('App starting...');
      loadKeys();
    });

    function loadKeys() {
      try {
        const stored = localStorage.getItem('keyCatalog');
        if (stored) {
          keys = JSON.parse(stored);
          console.log('Loaded keys:', keys.length);
        }
      } catch (error) {
        console.error('Error loading keys:', error);
      }

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      renderKeys();
    }

    function saveKeys() {
      try {
        localStorage.setItem('keyCatalog', JSON.stringify(keys));
      } catch (error) {
        console.error('Error saving keys:', error);
        alert('Failed to save. Your storage might be full.');
      }
    }

    function toggleAddForm() {
      const form = document.getElementById('addForm');
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        document.getElementById('keyName').value = '';
        document.getElementById('keyDescription').value = '';
        document.getElementById('imagePreview').classList.add('hidden');
        currentImageData = null;
      }
    }

    function previewImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        currentImageData = e.target.result.split(',')[1];
        const preview = document.getElementById('imagePreview');
        preview.src = 'data:image/jpeg;base64,' + currentImageData;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }

    function addKey() {
      const name = document.getElementById('keyName').value.trim();

      if (!name || !currentImageData) {
        alert('Please provide a name and image for the key');
        return;
      }

      const newKey = {
        id: Date.now(),
        name: name,
        description: document.getElementById('keyDescription').value.trim(),
        image: currentImageData,
        addedDate: new Date().toISOString()
      };

      keys.push(newKey);
      saveKeys();
      toggleAddForm();
      renderKeys();
    }

    function deleteKey(id) {
      if (!confirm('Are you sure you want to delete this key?')) return;

      keys = keys.filter(k => k.id !== id);
      saveKeys();
      renderKeys();
    }

    function renderKeys() {
      const grid = document.getElementById('keyGrid');
      const empty = document.getElementById('emptyState');
      const title = document.getElementById('catalogTitle');
      const identifyBtn = document.getElementById('identifyBtn');

      title.textContent = `Your Keys (${keys.length})`;
      identifyBtn.disabled = keys.length === 0;

      if (keys.length === 0) {
        grid.classList.add('hidden');
        empty.classList.remove('hidden');
      } else {
        grid.classList.remove('hidden');
        empty.classList.add('hidden');

        grid.innerHTML = keys.map(key => `
          <div class="key-card">
            <img src="data:image/jpeg;base64,${key.image}" alt="${key.name}">
            <div class="key-card-content">
              <h3>${key.name}</h3>
              ${key.description ? `<p class="description">${key.description}</p>` : ''}
              <p class="date">Added: ${new Date(key.addedDate).toLocaleDateString()}</p>
              <button class="btn-danger" onclick="deleteKey(${key.id})">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        `).join('');
      }
    }

    async function recognizeKey(event) {
      const file = event.target.files[0];
      if (!file || keys.length === 0) return;

      document.getElementById('recognizing').classList.remove('hidden');
      document.getElementById('recognitionResult').classList.add('hidden');

      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const uploadedImage = e.target.result.split(',')[1];

          const keyDescriptions = keys.map((key, idx) =>
            `Key ${idx + 1}: "${key.name}"${key.description ? ` - ${key.description}` : ''}`
          ).join('\n');

          const content = [{
            type: "text",
            text: `I have a catalog of keys. Please analyze the uploaded photo and determine which key from my catalog it matches, if any.

My cataloged keys:
${keyDescriptions}

Below I'll show you each cataloged key image followed by the photo of the key to identify.

Please respond with ONLY a JSON object in this exact format (no markdown, no backticks):
{
  "matchFound": true or false,
  "matchedKeyName": "name of matched key or null",
  "confidence": "high/medium/low",
  "reasoning": "brief explanation"
}`
          }];

          keys.forEach((key, idx) => {
            content.push({
              type: "text",
              text: `\n--- Catalog Key ${idx + 1}: ${key.name} ---`
            });
            content.push({
              type: "image",
              source: { type: "base64", media_type: "image/jpeg", data: key.image }
            });
          });

          content.push({
            type: "text",
            text: "\n--- Key to Identify ---"
          });
          content.push({
            type: "image",
            source: { type: "base64", media_type: "image/jpeg", data: uploadedImage }
          });

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1000,
              messages: [{ role: "user", content: content }]
            })
          });

          const data = await response.json();
          const resultText = data.content[0].text;
          const cleanResult = resultText.replace(/```json\n?|\n?```/g, '').trim();
          const result = JSON.parse(cleanResult);

          showResult(result, uploadedImage);
        };
        reader.readAsDataURL(file);
      } catch (error) {
        console.error('Recognition error:', error);
        alert('Error recognizing key: ' + error.message);
        document.getElementById('recognizing').classList.add('hidden');
      }
    }

    function showResult(result, uploadedImage) {
      document.getElementById('recognizing').classList.add('hidden');
      const resultDiv = document.getElementById('recognitionResult');
      resultDiv.classList.remove('hidden');

      const imagesDiv = document.getElementById('resultImages');
      let imagesHTML = `
        <div>
          <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">Uploaded Photo</h3>
          <img src="data:image/jpeg;base64,${uploadedImage}" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
        </div>
      `;

      if (result.matchFound) {
        const matchedKey = keys.find(k => k.name === result.matchedKeyName);
        if (matchedKey) {
          imagesHTML += `
            <div>
              <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">Matched Key</h3>
              <img src="data:image/jpeg;base64,${matchedKey.image}" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
            </div>
          `;
        }
      }

      imagesDiv.innerHTML = imagesHTML;

      const infoDiv = document.getElementById('resultInfo');
      infoDiv.className = 'result-box ' + (result.matchFound ? 'result-success' : 'result-error');
      infoDiv.innerHTML = `
        <p style="margin-bottom: 8px; font-size: 18px; font-weight: 600;">
          ${result.matchFound ? `‚úÖ Match Found: ${result.matchedKeyName}` : '‚ùå No Match Found'}
        </p>
        <p style="margin-bottom: 8px; font-size: 14px;">
          <strong>Confidence:</strong> ${result.confidence}
        </p>
        <p style="font-size: 14px;">
          <strong>Analysis:</strong> ${result.reasoning}
        </p>
      `;
    }

    function clearResult() {
      document.getElementById('recognitionResult').classList.add('hidden');
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(
        'data:application/javascript;base64,' + btoa(`
          self.addEventListener('install', () => self.skipWaiting());
          self.addEventListener('activate', (e) => e.waitUntil(clients.claim()));
        `)
      ).catch(e => console.log('SW registration failed'));
    }
  </script>

</body>
</html>