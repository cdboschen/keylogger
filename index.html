<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Finder</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîë</text></svg>">
    
    <!-- Apple Touch Icon (for iOS home screen) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><text y='140' font-size='140'>üîë</text></svg>">
    
    <!-- Android Chrome -->
    <link rel="manifest" id="manifest-placeholder">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        .header {
            max-width: 800px;
            margin: 0 auto 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            position: relative;
            text-align: center;
        }
        
        .header-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .key-icon {
            width: 50px;
            height: 50px;
        }
        
        .header-title {
            font-size: 2.2em;
            color: #333;
            font-weight: 700;
        }
        
        .header-subtitle {
            color: #666;
            font-size: 0.9em;
        }
        
        .settings-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #f8f9fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .settings-icon:hover {
            background: #667eea;
            border-color: #667eea;
            transform: rotate(90deg);
        }
        
        .settings-icon:hover svg {
            fill: white;
        }
        
        .settings-icon svg {
            width: 24px;
            height: 24px;
            fill: #667eea;
            transition: fill 0.3s;
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 90%;
            max-width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1999;
        }
        
        .settings-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .settings-header {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-header h2 {
            font-size: 1.5em;
        }
        
        .close-settings {
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-content {
            padding: 25px;
        }
        
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .settings-section:last-child {
            border-bottom: none;
        }
        
        .settings-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-section h3:hover {
            color: #764ba2;
        }
        
        .expand-arrow {
            font-size: 14px;
            transition: transform 0.3s;
            display: inline-block;
        }
        
        .expand-arrow.expanded {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.expanded {
            max-height: 2000px;
        }
        
        .key-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 600px) {
            .key-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .key-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .key-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .key-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .key-card-label {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .key-card-date {
            font-size: 11px;
            color: #999;
            margin-bottom: 8px;
        }
        
        .key-card-notes {
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .small-btn {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #video, #identifyVideo {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        #video.active, #identifyVideo.active {
            display: block;
        }
        
        .preview-canvas {
            max-width: 400px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .preview-canvas.active {
            display: block;
        }
        
        .delete-btn {
            background: #e74c3c;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .match-result {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .match-result.best-match {
            border-left-color: #2ecc71;
            background: #e8f8f5;
        }
        
        .match-result h3 {
            color: #2ecc71;
            margin-bottom: 10px;
        }
        
        .match-result img {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .match-score {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .no-match {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .storage-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #1976d2;
        }
        
        .hidden {
            display: none;
        }
        
        .tip {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #1976d2;
            border-left: 4px solid #667eea;
        }
        
        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .api-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .api-status.configured {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .api-status.not-configured {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .version-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .about-content {
            text-align: center;
            padding: 20px;
        }
        
        .about-content h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .about-content p {
            color: #666;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .about-content .version {
            color: #999;
            font-size: 12px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-settings" onclick="closeSettings()">√ó</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h3 onclick="toggleSection('keysSection')">
                    <span class="expand-arrow" id="keysArrow">‚ñ∂</span>
                    üîë Stored Keys
                </h3>
                <div class="collapsible-content" id="keysSection">
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">View and manage your saved keys</p>
                    <div id="keyGrid"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>üîß API Configuration</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Configure your Vercel API endpoint for AI-powered matching</p>
                <input type="text" id="apiEndpoint" placeholder="https://key-matcher-api.vercel.app/api/compare-keys">
                <button onclick="saveApiEndpoint()">Save Endpoint</button>
                <div id="apiStatus" class="api-status hidden"></div>
            </div>
            
            <div class="settings-section">
                <h3>üíæ Backup & Restore</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Export or import your key database</p>
                <button onclick="exportKeys()">üì§ Export Keys</button>
                <button onclick="document.getElementById('importFile').click()">üì• Import Keys</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importKeys(event)">
            </div>
            
            <div class="settings-section">
                <h3>‚ö†Ô∏è Danger Zone</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Permanently delete all stored keys</p>
                <button onclick="clearAllKeys()" class="delete-btn">üóëÔ∏è Clear All Keys</button>
            </div>
            
            <div class="settings-section">
                <h3>‚ÑπÔ∏è About</h3>
                <div class="about-content">
                    <h4>Key Finder</h4>
                    <p>by Dan Boschen</p>
                    <p style="font-size: 12px; color: #999;">(with help by Claude)</p>
                    <p style="margin-top: 15px;">December 26, 2025</p>
                    <p class="version">Version 241226.16</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <div class="header">
        <div class="header-title-wrapper">
            <svg class="key-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#f39c12">
                <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
            </svg>
            <h1 class="header-title">Key Finder</h1>
        </div>
        <div class="header-subtitle">AI-Powered Key Recognition System</div>
        
        <div class="settings-icon" onclick="openSettings()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
        </div>
        <div class="version-badge">v241226.16</div>
    </div>
    
    <div class="container">
        <div class="section">
            <h2>Add New Key</h2>
            <input type="text" id="keyLabel" placeholder="Enter key label (e.g., 'Front Door', 'Car Key')">
            <input type="text" id="keyNotes" placeholder="Additional notes (optional)">
            <video id="video" autoplay></video>
            <canvas id="captureCanvas" class="preview-canvas"></canvas>
            <div>
                <button id="addKeyBtn" onclick="startAddKey()">Add Key</button>
                <button id="captureBtn" class="hidden" onclick="captureAndSave()">Capture Photo</button>
            </div>
            <div class="tip">
                üì∏ <strong>Tip:</strong> Photograph the key blade clearly against a contrasting background. Focus on the teeth/cuts.
            </div>
            <div class="storage-info" id="storageInfo"></div>
        </div>
        
        <div class="section">
            <h2>Identify Unknown Key <span class="ai-badge">AI POWERED</span></h2>
            <video id="identifyVideo" autoplay></video>
            <canvas id="identifyCanvas" class="preview-canvas"></canvas>
            <div id="identifyResults"></div>
            <div>
                <button id="identifyKeyBtn" onclick="startIdentify()">Identify Key</button>
                <button id="captureIdentifyBtn" class="hidden" onclick="captureAndIdentify()">Capture Photo</button>
            </div>
            <div class="tip">
                ü§ñ <strong>AI Analysis:</strong> Claude AI compares teeth patterns only - ignoring color, material, and key shape.
            </div>
        </div>
    </div>

    <script>
        const APP_VERSION = "241226.16";
        
        const manifestData = {
            "name": "Key Finder",
            "short_name": "Key Finder",
            "description": "AI-Powered Key Recognition",
            "version": APP_VERSION,
            "start_url": ".",
            "display": "standalone",
            "background_color": "#667eea",
            "theme_color": "#667eea",
            "icons": [
                {
                    "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23667eea'/><text x='96' y='150' font-size='120' text-anchor='middle'>üîë</text></svg>",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23667eea'/><text x='256' y='400' font-size='320' text-anchor='middle'>üîë</text></svg>",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
        
        let videoStream = null;
        let identifyStream = null;
        let capturedImage = null;
        let identifyImage = null;
        let db;
        
        // Toggle collapsible section
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
            
            if (section.classList.contains('expanded')) {
                section.classList.remove('expanded');
                arrow.classList.remove('expanded');
            } else {
                section.classList.add('expanded');
                arrow.classList.add('expanded');
                // Load keys when expanding
                if (sectionId === 'keysSection') {
                    loadKeys();
                }
            }
        }
        
        // Settings panel functions
        function openSettings() {
            document.getElementById('settingsPanel').classList.add('open');
            document.getElementById('settingsOverlay').classList.add('visible');
        }
        
        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('open');
            document.getElementById('settingsOverlay').classList.remove('visible');
        }
        
        // Load saved API endpoint
        const savedEndpoint = localStorage.getItem('apiEndpoint');
        if (savedEndpoint) {
            document.getElementById('apiEndpoint').value = savedEndpoint;
            updateApiStatus(true);
        } else {
            updateApiStatus(false);
        }
        
        function updateApiStatus(configured) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.classList.remove('hidden');
            if (configured) {
                statusDiv.className = 'api-status configured';
                statusDiv.textContent = '‚úì API endpoint configured';
            } else {
                statusDiv.className = 'api-status not-configured';
                statusDiv.textContent = '‚ö† API endpoint not configured - AI matching will not work';
            }
        }
        
        function saveApiEndpoint() {
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            if (!endpoint) {
                alert('Please enter an API endpoint URL');
                return;
            }
            localStorage.setItem('apiEndpoint', endpoint);
            updateApiStatus(true);
            alert('API endpoint saved!');
        }
        
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('KeyDatabase', 4);
                
                request.onerror = () => reject(request.error);
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('DB initialized - v' + APP_VERSION);
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('keys')) {
                        db.createObjectStore('keys', { keyPath: 'id' });
                    }
                };
            });
        }
        
        async function startAddKey() {
            const label = document.getElementById('keyLabel').value.trim();
            
            if (!label) {
                alert('Please enter a key label first');
                return;
            }
            
            try {
                const video = document.getElementById('video');
                
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = videoStream;
                video.classList.add('active');
                
                document.getElementById('addKeyBtn').classList.add('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
            }
        }
        
        async function captureAndSave() {
            const label = document.getElementById('keyLabel').value.trim();
            const notes = document.getElementById('keyNotes').value.trim();
            const video = document.getElementById('video');
            const canvas = document.getElementById('captureCanvas');
            const context = canvas.getContext('2d');
            
            try {
                const maxSize = 800;
                let width = video.videoWidth;
                let height = video.videoHeight;
                
                if (width > height) {
                    if (width > maxSize) {
                        height = height * (maxSize / width);
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = width * (maxSize / height);
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                context.drawImage(video, 0, 0, width, height);
                
                capturedImage = canvas.toDataURL('image/jpeg', 0.8);
                canvas.classList.add('active');
                
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    video.classList.remove('active');
                }
                
                document.getElementById('addKeyBtn').classList.remove('hidden');
                document.getElementById('captureBtn').classList.add('hidden');
                
                await initDB();
                
                const key = {
                    id: Date.now(),
                    label: label,
                    notes: notes,
                    image: capturedImage,
                    timestamp: new Date().toISOString()
                };
                
                const transaction = db.transaction(['keys'], 'readwrite');
                const objectStore = transaction.objectStore('keys');
                const request = objectStore.add(key);
                
                request.onsuccess = () => {
                    document.getElementById('keyLabel').value = '';
                    document.getElementById('keyNotes').value = '';
                    
                    setTimeout(() => {
                        canvas.classList.remove('active');
                    }, 2000);
                    
                    capturedImage = null;
                    alert('Key saved successfully!');
                    updateStorageInfo();
                };
                
                request.onerror = () => {
                    alert('Error saving key: ' + request.error);
                };
                
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
        
        async function startIdentify() {
            document.getElementById('identifyResults').innerHTML = '';
            document.getElementById('identifyCanvas').classList.remove('active');
            
            try {
                const video = document.getElementById('identifyVideo');
                
                identifyStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = identifyStream;
                video.classList.add('active');
                
                document.getElementById('identifyKeyBtn').classList.add('hidden');
                document.getElementById('captureIdentifyBtn').classList.remove('hidden');
                
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
            }
        }
        
        async function captureAndIdentify() {
            const video = document.getElementById('identifyVideo');
            const canvas = document.getElementById('identifyCanvas');
            const context = canvas.getContext('2d');
            const resultsDiv = document.getElementById('identifyResults');
            
            const apiEndpoint = localStorage.getItem('apiEndpoint');
            if (!apiEndpoint) {
                alert('Please configure your API endpoint first. Click the settings icon in the top right.');
                return;
            }
            
            try {
                const maxSize = 800;
                let width = video.videoWidth;
                let height = video.videoHeight;
                
                if (width > height) {
                    if (width > maxSize) {
                        height = height * (maxSize / width);
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = width * (maxSize / height);
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                context.drawImage(video, 0, 0, width, height);
                
                identifyImage = canvas.toDataURL('image/jpeg', 0.8);
                canvas.classList.add('active');
                
                if (identifyStream) {
                    identifyStream.getTracks().forEach(track => track.stop());
                    video.classList.remove('active');
                }
                
                document.getElementById('identifyKeyBtn').classList.remove('hidden');
                document.getElementById('captureIdentifyBtn').classList.add('hidden');
                
                resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing tooth pattern with AI...</p></div>';
                
                await initDB();
                const keys = await getAllKeys();
                
                if (keys.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-match">No keys in database. Please add some keys first.</div>';
                    return;
                }
                
                // Call API
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        unknownKey: identifyImage,
                        storedKeys: keys.map(k => ({ label: k.label, image: k.image }))
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed: ' + response.statusText);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                const aiResults = data.results || [];
                
                // Map results back to full key objects with validation
                const matches = aiResults
                    .filter(result => result.index !== undefined && keys[result.index])
                    .map(result => ({
                        key: keys[result.index],
                        similarity: result.similarity || 0,
                        reasoning: result.reasoning || 'No reasoning provided'
                    }));
                
                console.log('Mapped matches:', matches);
                
                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-match">API returned no valid matches. Check the browser console for details.</div>';
                    return;
                }
                
                displayMatches(matches, resultsDiv);
                
            } catch (err) {
                resultsDiv.innerHTML = `<div class="no-match">‚ùå Error: ${err.message}<br><br>Make sure your API endpoint is configured correctly in Settings.</div>`;
                console.error(err);
            }
        }
        
        function displayMatches(matches, resultsDiv) {
            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div class="no-match">No matches found.</div>';
                return;
            }
            
            let html = '';
            const topMatches = matches.slice(0, 3);
            
            topMatches.forEach((match, index) => {
                const isBestMatch = index === 0 && match.similarity > 70;
                const matchClass = isBestMatch ? 'match-result best-match' : 'match-result';
                
                html += `
                    <div class="${matchClass}">
                        ${isBestMatch ? '<h3>‚úì Best Match (AI)</h3>' : '<h3>Possible Match #' + (index + 1) + '</h3>'}
                        <div class="match-score">${match.similarity}% Similar</div>
                        <p><strong>Label:</strong> ${match.key.label}</p>
                        ${match.reasoning ? `<p><strong>AI Analysis:</strong> ${match.reasoning}</p>` : ''}
                        ${match.key.notes ? `<p><strong>Notes:</strong> ${match.key.notes}</p>` : ''}
                        <p><strong>Added:</strong> ${new Date(match.key.timestamp).toLocaleDateString()}</p>
                        <img src="${match.key.image}" alt="${match.key.label}">
                    </div>
                `;
            });
            
            if (matches[0].similarity < 70) {
                html = '<div class="no-match">‚ö†Ô∏è No confident matches found. Best match: ' + matches[0].similarity + '%</div>' + html;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        async function getAllKeys() {
            await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['keys'], 'readonly');
                const objectStore = transaction.objectStore('keys');
                const request = objectStore.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function loadKeys() {
            const keys = await getAllKeys();
            const keyGrid = document.getElementById('keyGrid');
            
            if (keys.length === 0) {
                keyGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîë</div>
                        <p>No keys stored yet</p>
                    </div>
                `;
                updateStorageInfo();
                return;
            }
            
            keyGrid.innerHTML = `
                <div class="key-grid">
                    ${keys.map(key => `
                        <div class="key-card">
                            <img src="${key.image}" alt="${key.label}">
                            <div class="key-card-label">${key.label}</div>
                            <div class="key-card-date">${new Date(key.timestamp).toLocaleDateString()}</div>
                            ${key.notes ? `<div class="key-card-notes">${key.notes}</div>` : ''}
                            <button class="delete-btn small-btn" onclick="deleteKey(${key.id})">Delete</button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            updateStorageInfo();
        }
        
        async function deleteKey(id) {
            if (confirm('Are you sure you want to delete this key?')) {
                await initDB();
                const transaction = db.transaction(['keys'], 'readwrite');
                const objectStore = transaction.objectStore('keys');
                objectStore.delete(id);
                
                await new Promise((resolve) => {
                    transaction.oncomplete = resolve;
                });
                
                loadKeys();
            }
        }
        
        async function clearAllKeys() {
            if (confirm('Are you sure you want to delete ALL keys? This cannot be undone.')) {
                await initDB();
                const transaction = db.transaction(['keys'], 'readwrite');
                const objectStore = transaction.objectStore('keys');
                objectStore.clear();
                
                await new Promise((resolve) => {
                    transaction.oncomplete = resolve;
                });
                
                loadKeys();
                alert('All keys have been deleted.');
            }
        }
        
        async function updateStorageInfo() {
            const keys = await getAllKeys();
            
            let totalSize = 0;
            keys.forEach(key => {
                totalSize += key.image.length;
            });
            
            const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
            
            const infoDiv = document.getElementById('storageInfo');
            infoDiv.innerHTML = `${keys.length} keys stored | ~${sizeMB} MB used`;
        }
        
        async function exportKeys() {
            const keys = await getAllKeys();
            if (keys.length === 0) {
                alert('No keys to export');
                return;
            }
            
            const dataStr = JSON.stringify(keys, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `keys-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`Exported ${keys.length} keys successfully!`);
        }
        
        async function importKeys(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedKeys = JSON.parse(e.target.result);
                    
                    await initDB();
                    const transaction = db.transaction(['keys'], 'readwrite');
                    const objectStore = transaction.objectStore('keys');
                    
                    let count = 0;
                    for (const key of importedKeys) {
                        key.id = Date.now() + Math.random();
                        objectStore.add(key);
                        count++;
                    }
                    
                    transaction.oncomplete = () => {
                        alert(`Imported ${count} keys successfully!`);
                        loadKeys();
                    };
                    
                } catch (err) {
                    alert('Error importing keys: ' + err.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        window.onload = async () => {
            await initDB();
            updateStorageInfo();
        };
    </script>
</body>
</html>
